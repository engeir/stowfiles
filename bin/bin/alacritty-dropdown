#!/usr/bin/env bash

# Requirements: xdotool, xrandr, awk, Alacritty v0.12+
check_program() {
    if ! command -v "$1" >/dev/null 2>&1; then
        echo "Error: $1 is not installed"
        exit 1
    fi
}

check_program xdotool
check_program xrandr
check_program awk
check_program alacritty

# User preference (font size scaling; tweak these if necessary)
base_font_size=8        # points (default font size in Alacritty or your config)
base_screen_height=1080 # px: reference for scaling font size

# Get mouse position
eval "$(xdotool getmouselocation --shell)"
mouseX=$X
mouseY=$Y

# Find active monitor by mouse location
active_monitor=""
active_geometry=""
while read -r name rest; do
    [[ $rest =~ connected ]] || continue
    [[ $rest =~ ([0-9]+)x([0-9]+)\+([0-9]+)\+([0-9]+) ]] || continue
    width=${BASH_REMATCH[1]}
    height=${BASH_REMATCH[2]}
    X0=${BASH_REMATCH[3]}
    Y0=${BASH_REMATCH[4]}
    X1=$((X0 + width))
    Y1=$((Y0 + height))
    if ((mouseX >= X0 && mouseX < X1 && mouseY >= Y0 && mouseY < Y1)); then
        active_monitor="$name"
        active_geometry="$width $height $X0 $Y0"
        break
    fi
done < <(xrandr | grep ' connected')

if [[ -z $active_monitor ]]; then
    echo "Could not determine active monitor!"
    exit 1
fi
read mon_width mon_height mon_x mon_y <<<"$active_geometry"

# Scale font size proportional to monitor height
font_size=$(awk "BEGIN {printf \"%.1f\", $mon_height/$base_screen_height * $base_font_size}")

# Estimate font character width/height in pixels - tweak as needed for your setup!
char_width=16  # Typical monospace font character width in px
char_height=32 # Typical monospace font height in px (change if you use a different font/size)

# Calculate columns/rows to fit 80% of monitor side, rounding down
columns=$(awk "BEGIN {print int(($mon_width * 0.9) / $char_width)}")
rows=$(awk "BEGIN {print int(($mon_height * 0.9) / $char_height)}")

# Launch Alacritty with window size and font size
alacritty \
    -t "dropdown" \
    --class "dropdown" \
    --option "window.dimensions.columns=${columns}" \
    --option "window.dimensions.lines=${rows}" \
    --option "font.size=${font_size}" \
    -e "$@"
