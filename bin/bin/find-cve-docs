#!/usr/bin/env bash

# find-cve-docs – quick lookup & open the official advisory for a CVE
#
# Usage:
#   find-cve-docs <CVE-ID>
#
# Example:
#   find-cve-docs 2026-23876
#
# The script searches a small local table of known CVEs and opens the
# corresponding advisory page in the default web browser. If the CVE
# is not known, it prints an informative message.
#
# To extend the table, add or modify entries in the `cve_map` section.
# Keys are CVE IDs; values are URLs pointing to the official advisory.
#
# Use
# https://www.cve.org/Downloads
# to download all CVEs ever.

set -euo pipefail

# ------------------------------------------------------------------
# 1.  CVE ↔ URL mapping
# ------------------------------------------------------------------
declare -A cve_map=(
    ["2026-23876"]="$(
        cat <<'EOF'
https://access.redhat.com/security/cve/cve-2026-23876#cve-affected-packages
https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2026-23876
https://security-tracker.debian.org/tracker/CVE-2026-23876
https://ubuntu.com/security/CVE-2026-23876
https://www.suse.com/security/cve/CVE-2026-23876.html
EOF
    )"
)

# ------------------------------------------------------------------
# 2.  Helper: Open URL in default browser
# ------------------------------------------------------------------
open_in_browser() {
    local url="$1"
    if command -v xdg-open >/dev/null 2>&1; then
        xdg-open "$url" &
    elif command -v open >/dev/null 2>&1; then # macOS
        open "$url"
    else
        echo "ERROR: Cannot find a program to open URLs (xdg-open or open)." >&2
        return 1
    fi
}

# ------------------------------------------------------------------
# 3.  Main logic
# ------------------------------------------------------------------
if [[ $# -eq 1 ]]; then
    cve_id="${1^^}"
else
    if [[ -t 0 ]]; then
        echo "Usage: $0 <CVE-ID>" >&2
        exit 1
    else
        cve_id=$(cat -)
        cve_id="${cve_id^^}"
    fi
fi

if [[ -n ${cve_map[$cve_id]:-} ]]; then
    # Convert multi-line string to array, one URL per line
    mapfile -t urls <<<"${cve_map[$cve_id]}"
    for url in "${urls[@]}"; do
        # Skip empty lines
        [[ -z $url ]] && continue
        echo "Opening advisory for $cve_id: $url"
        open_in_browser "$url"
    done
else
    echo "No known advisory for CVE $cve_id." >&2
    exit 1
fi

