#!/bin/env bash
# From: https://github.com/naelstrof/slop

has() {
    if ! command -v "$1" >/dev/null 2>&1; then
        echo "$1 is not installed. Adjust $0 if you think you do not need it."
        notify-send "$1 is not installed. Adjust $0 if you think you do not need it."
        exit 1
    fi
}
has "tesseract"
has "dmenu"
has "clipcatctl"
if [[ -n $WAYLAND_DISPLAY ]]; then
    has "slurp"
    has "grim"
else
    has "slop"
    has "import"
fi

# If no language argument provided, use `dmenu` to select
if [[ $# -eq 0 ]]; then
    LANG=$(tesseract --list-langs 2>/dev/null | tail -n +2 | dmenu -c -p "Select language: ")
    if [[ -z $LANG ]]; then
        echo "No language selected"
        exit 1
    fi
else
    LANG="$1"
fi

if ! grep "^$LANG$" <(tesseract --list-langs 2>/dev/null | tail -n +2) >/dev/null 2>&1; then
    echo "Install tesseract trained data for language $LANG, or edit $0."
    notify-send "Install tesseract trained data for language $LANG, or edit $0."
    exit 1
fi

imagefile="/tmp/sloppy.$RANDOM.png"
text="/tmp/translation"
if [[ -n $WAYLAND_DISPLAY ]]; then
    grim -g "$(slurp)" "$imagefile"
else
    slop=$(slop -f "%g") || exit 1
    read -r G <<<"$slop"
    import -window root -crop "$G" "$imagefile"
fi
tesseract -l "$LANG" "$imagefile" "$text" 2>/dev/null
clipcatctl insert "$(cat "$text.txt")"
