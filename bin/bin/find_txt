#!/usr/bin/env bash

# Adjusted from: https://github.com/naelstrof/slop
#
# This script uses a patched version of dmenu that introduce the center flag.
#     https://github.com/engeir/dmenu-flexipatch
# Remove the `-c` (center) flag and optionally the `-fn` (font) option for the vanilla
# experience.

has() {
    if ! command -v "$1" >/dev/null 2>&1; then
        echo "$1 is not installed. Adjust $0 if you think you do not need it."
        notify-send "$1 is not installed. Adjust $0 if you think you do not need it."
        exit 1
    fi
}
has "tesseract"

if [[ -n $WAYLAND_DISPLAY ]]; then
    has "slurp"
    has "grim"
else
    has "slop"
    has "import"
fi

# If no language argument provided, use `dmenu` to select
if [[ $# -eq 0 ]]; then
    has "dmenu"
    LANG=$(tesseract --list-langs 2>/dev/null | tail -n +2 | dmenu -nb "#2d2d2d" -nf "#7070c2" -sb "#8c8cd0" -sf "#2d2d2d" -fn "CaskaydiaMono Nerd Font:size=14" -l 20 -c -p "Select language: ")
    if [[ -z $LANG ]]; then
        echo "No language selected"
        exit 1
    fi
else
    LANG="$1"
fi

if ! grep "^$LANG$" <(tesseract --list-langs 2>/dev/null | tail -n +2) >/dev/null 2>&1; then
    echo "Install tesseract trained data for language $LANG, or edit $0."
    notify-send "Install tesseract trained data for language $LANG, or edit $0."
    exit 1
fi

imagefile="/tmp/sloppy.$RANDOM.png"
text="/tmp/translation"
if [[ -n $WAYLAND_DISPLAY ]]; then
    grim -g "$(slurp)" "$imagefile"
else
    slop=$(slop -f "%g") || exit 1
    read -r G <<<"$slop"
    import -window root -crop "$G" "$imagefile"
fi
tesseract -l "$LANG" "$imagefile" "$text" 2>/dev/null
if has "clipcatctl"; then
    clipcatctl insert "$(cat "$text.txt")"
else
    cat "$text.txt" | xclip -sel copy
fi
