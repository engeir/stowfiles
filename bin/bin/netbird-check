#!/bin/bash

# Continuously check connectivity to vg.no and ip.nhn.no
# If both fail, restart netbird

check_connectivity() {
    timeout 5 ping -c 3 -W 5 vg.no >/dev/null 2>&1
    vg_status=$?

    timeout 5 ping -c 3 -W 5 helsegitlab.nhn.no >/dev/null 2>&1
    nhn_status=$?

    if [ "$vg_status" -ne 0 ] && [ "$nhn_status" -ne 0 ]; then
        echo "$(date): Both vg.no and helsegitlab.nhn.no unreachable. Restarting netbird..."
        netbird down
        sleep 2
        netbird up --enable-rosenpass --rosenpass-permissive
        echo "$(date): Netbird restarted"
    else
        echo "$(date): Connectivity OK"
    fi
}

echo "Starting netbird connectivity monitor..."
echo "Press Ctrl+C to stop"

while true; do
    check_connectivity
    sleep 5
done
