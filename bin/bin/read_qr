#!/bin/env bash
# Read QR codes

has() {
    if ! command -v "$1" >/dev/null 2>&1; then
        echo "$1 is not installed. Adjust $0 if you think you do not need it."
        notify-send "$1 is not installed. Adjust $0 if you think you do not need it."
        exit 1
    fi
}

if [[ -n $WAYLAND_DISPLAY ]]; then
    has grim
    has slurp
else
    has slop
    has import
fi
has zbarimg
has clipcatctl

imagefile="/tmp/sloppy.$RANDOM.png"
text="/tmp/translation"
if [[ -n $WAYLAND_DISPLAY ]]; then
    grim -g "$(slurp)" "$imagefile"
else
    slop=$(slop -f "%g") || exit 1
    read -r G <<<"$slop"
    import -window root -crop "$G" "$imagefile"
fi
zbarimg -q --raw "$imagefile" >"$text"
clipcatctl insert "$(cat "$text")"
