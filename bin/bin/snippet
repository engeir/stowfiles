#!/usr/bin/env bash

# This is `snippet`
#
# Optional arguments: `new` (default, create new snippet), `edit` (edit an existing
# snippet), and `delete` (delete an existing snippet).

set -euo pipefail

SNIP_DIR="$HOME/.local/share/snippets"
mkdir -p "$SNIP_DIR"

# Only markdown files are allowed here
# fd -E "*md" . "$SNIP_DIR" -X rm

ACTION="${1:-new}"

choose_file() {
    local files
    mapfile -t files < <(find "$SNIP_DIR" -maxdepth 1 -type f -name '*.md' -exec basename {} \;)

    if [[ ${#files[@]} -eq 0 ]]; then
        gum log --level error "No notes found."
        return 1
    fi

    gum filter \
        --placeholder "Type to search your snippets..." \
        --height 20 \
        --limit 1 \
        --prompt "› " \
        --fuzzy \
        "${files[@]}"
}

case "$ACTION" in
    new)
        while true; do
            FILENAME="$(gum input --placeholder="Give the file a name...")"
            # Check for blank input
            if [[ -z $FILENAME ]]; then
                gum confirm "No name provided. Try again?" || exit 1
                continue
            fi

            # Add .md extension if not present
            if [[ ${FILENAME##*.} != "md" ]]; then
                FILENAME="${FILENAME}.md"
            fi

            FULL_PATH="$SNIP_DIR/$FILENAME"

            if [[ -e $FULL_PATH ]]; then
                gum confirm "The file '$FILENAME' already exists. Edit it?" && {
                    gum write --placeholder "Edit your note..." <"$FULL_PATH" >"$FULL_PATH.$$" && mv "$FULL_PATH.$$" "$FULL_PATH"
                    echo "Note edited at $FULL_PATH"
                    exit 0
                }
                gum confirm "Try a different filename?" || exit 1
            else
                gum write --placeholder "What do you want to note down?" >"$FULL_PATH"
                echo "Note saved at $FULL_PATH"
                exit 0
            fi
        done
        ;;
    edit)
        FILE_TO_EDIT="$(choose_file)" || exit 1
        gum write --placeholder "Edit your note..." <"$SNIP_DIR/$FILE_TO_EDIT" >"$SNIP_DIR/$FILE_TO_EDIT.$$"
        mv "$SNIP_DIR/$FILE_TO_EDIT.$$" "$SNIP_DIR/$FILE_TO_EDIT"
        echo "Note edited at $SNIP_DIR/$FILE_TO_EDIT"
        ;;
    delete)
        FILE_TO_DELETE="$(choose_file)" || exit 1
        gum confirm "Really delete '$FILE_TO_DELETE'?" && {
            rm -f "$SNIP_DIR/$FILE_TO_DELETE"
            echo "Deleted: $SNIP_DIR/$FILE_TO_DELETE"
        }
        ;;
    rename)
        FILE_TO_RENAME="$(choose_file)" || exit 1
        CURRENT_NAME="${FILE_TO_RENAME%.md}"

        while true; do
            NEW_FILENAME="$(gum input --placeholder="Enter new name..." --value="$CURRENT_NAME")"

            if [[ -z $NEW_FILENAME ]]; then
                gum log --level error "No name provided."
                gum confirm "Try again?" || exit 1
                continue
            fi

            # Add .md extension if not present
            if [[ ${NEW_FILENAME##*.} != "md" ]]; then
                NEW_FILENAME="${NEW_FILENAME}.md"
            fi

            # Check if trying to rename to same name
            if [[ $NEW_FILENAME == "$FILE_TO_RENAME" ]]; then
                gum log --level info "Same filename, no changes made."
                exit 0
            fi

            NEW_PATH="$SNIP_DIR/$NEW_FILENAME"

            if [[ -e $NEW_PATH ]]; then
                gum log --level error "File '$NEW_FILENAME' already exists."
                gum confirm "Try a different name?" || exit 1
                continue
            fi

            mv "$SNIP_DIR/$FILE_TO_RENAME" "$NEW_PATH"
            echo "Renamed: $FILE_TO_RENAME → $NEW_FILENAME"
            exit 0
        done
        ;;
    prune)
        # Find likely gum write "temp" files (pattern: name.md.NNNNNN) in $SNIP_DIR
        temp_files=()
        while IFS= read -r -d '' f; do
            temp_files+=("$(basename "$f")")
        done < <(find "$SNIP_DIR" -maxdepth 1 -type f -regextype posix-egrep -regex ".*/[^/]+\.md\.[0-9]+" -print0)

        if [[ ${#temp_files[@]} -eq 0 ]]; then
            gum log --level info "No temporary/leftover snippet files found to prune."
            exit 0
        fi

        TO_DELETE=$(printf "%s\n" "${temp_files[@]}" | gum choose --no-limit --header="Orphaned snippet files (select to delete):")
        if [[ -z ${TO_DELETE:-} ]]; then
            gum log --level info "No files selected for deletion."
            exit 0
        fi

        gum confirm "Delete the selected files?" || exit 1
        # If multi-select, TO_DELETE may have multiple lines
        while IFS= read -r file; do
            if [[ -n $file ]]; then
                rm -f "$SNIP_DIR/$file"
                echo "Deleted: $SNIP_DIR/$file"
            fi
        done <<<"$TO_DELETE"
        ;;
    git)
        if [[ $# -lt 2 ]]; then
            echo "Usage: $0 git <subcommand> [args...]"
            echo "Available git subcommands: init, clone, push, pull, or any git command"
            exit 1
        fi

        GIT_SUBCOMMAND="${2}"
        shift 2

        case "$GIT_SUBCOMMAND" in
            init)
                if [[ -d "$SNIP_DIR/.git" ]]; then
                    gum log --level warn "Git repository already exists in $SNIP_DIR"
                    gum confirm "Reinitialize the repository?" || exit 0
                fi
                cd "$SNIP_DIR"
                git init
                gum log --level info "Git repository initialized in $SNIP_DIR"
                ;;
            clone)
                if [[ $# -lt 1 ]]; then
                    echo "Usage: $0 git clone <repository-url>"
                    exit 1
                fi
                REPO_URL="$1"

                if [[ -d "$SNIP_DIR/.git" ]]; then
                    gum log --level warn "Git repository already exists in $SNIP_DIR"
                    exit 1
                fi

                files_exist=false
                if [[ -n "$(ls -A "$SNIP_DIR" 2>/dev/null)" ]]; then
                    files_exist=true
                    gum log --level warn "Snippet directory is not empty"
                    gum confirm "Clone into existing directory? (may overwrite files)" || exit 1
                fi

                cd "$SNIP_DIR"
                if [[ $files_exist == true ]]; then
                    git clone "$REPO_URL" temp_clone
                    mv temp_clone/.git .
                    mv temp_clone/* . 2>/dev/null || true
                    mv temp_clone/.* . 2>/dev/null || true
                    rmdir temp_clone
                else
                    git clone "$REPO_URL" .
                fi
                gum log --level info "Repository cloned to $SNIP_DIR"
                ;;
            push)
                if [[ ! -d "$SNIP_DIR/.git" ]]; then
                    gum log --level error "Not a git repository. Run 'snippet git init' first."
                    exit 1
                fi
                cd "$SNIP_DIR"
                git add .
                git commit -m "auto-commit snippets" || gum log --level info "No changes to commit"
                git push "$@"
                ;;
            pull)
                if [[ ! -d "$SNIP_DIR/.git" ]]; then
                    gum log --level error "Not a git repository. Run 'snippet git init' first."
                    exit 1
                fi
                cd "$SNIP_DIR"
                git pull "$@"
                ;;
            *)
                if [[ ! -d "$SNIP_DIR/.git" ]]; then
                    gum log --level error "Not a git repository. Run 'snippet git init' first."
                    exit 1
                fi
                cd "$SNIP_DIR"
                git "$GIT_SUBCOMMAND" "$@"
                ;;
        esac
        ;;
    format)
        cd "$SNIP_DIR" >/dev/null 2>&1
        prettier --write ./**/*.md | grep -v "unchanged" && true
        cd - >/dev/null 2>&1
        ;;
    browse)
        # Check for flags
        SEARCH_MODE=false
        DMENU_MODE=false

        case "${2:-}" in
            "--search"|"-s")
                SEARCH_MODE=true
                shift 2
                ;;
            "--dmenu"|"-d")
                DMENU_MODE=true
                shift 2
                ;;
        esac

        cd "$SNIP_DIR" || exit 1
        export PATH="$PATH:$HOME/.local/share/mise/shims/"

        # Extract snippet function
        extract_snippet() {
            local file="$1"
            local first_line
            first_line=$(head -n 1 "$file")
            if [[ $first_line =~ ^'```' ]]; then
                sed -n '2p' "$file"
            else
                echo "$first_line"
            fi
        }
        export -f extract_snippet

        if [[ $DMENU_MODE == true ]]; then
            # Dmenu mode - directly type the selection
            setxkbmap no
            xdotool type "$(fd -e md -x sh -c 'echo "{.} // $(extract_snippet "{}")"' | dmenu -nb "#2d2d2d" -nf "#7070c2" -sb "#8c8cd0" -sf "#2d2d2d" -fn "CaskaydiaMono Nerd Font:size=14" -l 20 -c | sed 's|^[^ ]* // ||')"
            exit 0
        elif [[ $SEARCH_MODE == true ]]; then
            # Advanced search with ripgrep + fzf
            TEMP=$(mktemp -u)
            export TEMP
            trap 'rm -f "$TEMP"' EXIT
            INITIAL_QUERY="${*:-}"
            TRANSFORMER="
              rg_pat={q:1}      # The first word is passed to ripgrep
              fzf_pat={q:2..}   # The rest are passed to fzf
              if ! [[ -r \"$TEMP\" ]] || [[ \$rg_pat != \$(cat \"$TEMP\") ]]; then
                echo \"\$rg_pat\" > \"$TEMP\"
                printf \"reload:sleep 0.1; rg --column --line-number --no-heading --color=always --smart-case %q || true\" \"\$rg_pat\"
              fi
              echo \"+search:\$fzf_pat\"
            "
            CHOSEN="$(fzf --ansi --disabled --query "$INITIAL_QUERY" \
                --with-shell 'bash -c' \
                --bind "start,ctrl-k:preview-up,ctrl-j:preview-down,change:transform:$TRANSFORMER" \
                --color "hl:-1:underline,hl+:-1:underline:reverse" \
                --delimiter : \
                --preview 'bat --color=always {1} --highlight-line {2}' \
                --preview-window '<80(up:65%),border-line,+{2}+3/3,~3' \
                | sed 's/\(.*\.md\).*/\1/' | xargs -I {} sh -c "extract_snippet {}")"
        else
            # Simple file browse with preview
            if command -v tvee >/dev/null 2>&1; then
                CLI="tv"
            else
                CLI='fzf --bind "ctrl-k:preview-up,ctrl-j:preview-down" --preview "bat --color=always {}" --preview-window "<80(up:65%),border-line,+{2}+3/3,~3"'
            fi
            CHOSEN="$(find . -name "*.md" -exec basename {} \; | eval "$CLI" | xargs -I {} sh -c "extract_snippet {}")"
        fi

        if [[ -z $CHOSEN ]]; then
            exit 0
        fi

        # Action menu
        echo "What would you like to do?"
        echo "1) Copy to clipboard"
        echo "2) Open/Execute"
        echo "3) Both (copy and open)"
        read -r -n 1 choice

        case $choice in
            1)
                if command -v clipcatctl >/dev/null 2>&1; then
                    clipcatctl insert "$CHOSEN"
                elif command -v xclip >/dev/null 2>&1; then
                    echo "$CHOSEN" | xclip -selection clipboard
                else
                    echo "$CHOSEN"
                fi
                ;;
            2)
                if [[ $CHOSEN =~ ^https?:// ]]; then
                    xdg-open "$CHOSEN"
                else
                    echo "$CHOSEN"
                fi
                ;;
            3)
                if command -v clipcatctl >/dev/null 2>&1; then
                    clipcatctl insert "$CHOSEN"
                elif command -v xclip >/dev/null 2>&1; then
                    echo "$CHOSEN" | xclip -selection clipboard
                fi
                if [[ $CHOSEN =~ ^https?:// ]]; then
                    xdg-open "$CHOSEN"
                else
                    echo "$CHOSEN"
                fi
                ;;
            *)
                echo "Invalid choice."
                exit 1
                ;;
        esac
        ;;
    *)
        echo "Usage: $0 [new|edit|delete|rename|browse|prune|format|git]"
        echo ""
        echo "Actions:"
        echo "  new     - Create a new snippet (default)"
        echo "  edit    - Edit an existing snippet"
        echo "  delete  - Delete an existing snippet"
        echo "  rename  - Rename an existing snippet"
        echo "  browse  - Browse and select snippet content"
        echo "          --search, -s : Search within file contents"
        echo "          --dmenu, -d  : Use dmenu and type selection directly"
        echo "  prune   - Remove temporary/orphaned files"
        echo "  format  - Format all snippets with prettier"
        echo "  git     - Git operations in snippet directory"
        echo ""
        echo "Git usage: $0 git <command> [args...]"
        echo "  Common commands: init, clone <url>, push, pull, status, add, commit"
        exit 1
        ;;
esac
