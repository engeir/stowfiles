#!/usr/bin/env bash

if ! command -v xclip 1>/dev/null; then
    echo "The script depends on xclip."
    exit 1
fi

# Get the URL from the clipboard
url=$(xclip -o -selection clipboard)

junta() {
    # Use regex to extract the shortened URL
    shortened_url=$(echo "$url" | grep -oP '^https://.*/\d{6}')
    # If the word "tickets" is found, remove it:
    if [[ $shortened_url =~ tickets ]]; then
        shortened_url=${shortened_url/tickets\//}
    fi

    # If already shortened, extract just the ticket number
    if [[ $shortened_url =~ ^https://.*?/([0-9]{6})$ ]]; then
        ticket_number="${BASH_REMATCH[1]}"
    fi
}
esm() {
    base_url=$(echo "$url" | grep -oP '^https://.*?/')

    # Extract the first sequence of at least 5 digits from the URL
    if [[ $url =~ [0-9]{5,} ]]; then
        ticket_number="${BASH_REMATCH[0]}"
        shortened_url="$base_url$ticket_number"
    else
        shortened_url='' # Set to empty if no numeric segment found
    fi
}

if echo "$url" | grep -q "https://junta.*"; then
    junta
elif echo "$url" | grep -q "https://esm.*"; then
    esm
fi

# If we have a ticket number from an already shortened URL, use that
if [[ -n $ticket_number && $url =~ ^https://.*?/[0-9]+$ ]]; then
    shortened_url="$ticket_number"
fi

# Check if the URL matches the expected format
if [[ -n $shortened_url ]]; then
    echo "Shortened URL: $shortened_url"

    # Copy the shortened URL back to the clipboard
    if command -v clipcatctl >/dev/null 2>&1; then
        clipcatctl insert "$shortened_url"
    else
        echo "$shortened_url" | xclip -sel clip >/dev/null
    fi
    echo "Shortened URL has been copied to the clipboard."
else
    echo "Invalid URL format or no URL found in clipboard."
fi
