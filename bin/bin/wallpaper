#!/usr/bin/env bash

mkdir -p "$HOME/.cache/wallpaper"
if [[ $(uname -s) == "Darwin" ]]; then
    # Mac
    dmenu='dmenu-mac'
    # Choose from any wallpapers and reset
    # First show the files in dmenu and catch the full path
    chosen=$(fd -e png -e jpg . "$HOME/syncthing/aerial-views" | sed 's:.*/::' | eval "$dmenu")

    # Exit if none is chosen
    [ "$chosen" = "" ] && exit

    DIR=$(fd -e png -e jpg "$chosen" "$HOME/syncthing/aerial-views")
    # DIR=$(ls ~/.config/wallpaper/wallpaper*/* | grep "$chosen")

    # Copy the selected wallpaper to be the main wallpaper
    cp "$DIR" "$HOME"/.cache/wallpaper/wallpaper.jpg
    # convert "$DIR" -blur 0x9 "$HOME/.cache/wallpaper/wallpaper.jpg"

    # Set the new wallpaper
    m wallpaper "$DIR"
else
    if [[ $XDG_SESSION_TYPE == "wayland" ]]; then
        set_wp="swaybg -m fill -i"
        dmenu='mew -l 15'
    else
        set_wp="feh --bg-fill"
        dmenu='dmenu -c -l 15'
    fi
    # Linux
    get_img() {
        if command -v nsxiv >/dev/null 2>&1; then
            chosen=$(nsxiv -obtf "$HOME/syncthing/aerial-views/")
        else
            chosen=$(fd -e png -e jpg . "$HOME/syncthing/aerial-views" | sed 's:.*/::' | eval "$dmenu")
            [ "$chosen" = "" ] && exit
            chosen=$(fd "$chosen" "$HOME/syncthing/aerial-views")
        fi
    }
    valid_input=false
    while [ "$valid_input" = false ]; do
        get_img
        if [[ $chosen == "" ]]; then
            notify-send "Wallpaper picker" "Use Q to select an image."
        else
            valid_input=true
        fi
    done
    cp "$chosen" "$HOME"/.cache/wallpaper/wallpaper.jpg

    eval "$set_wp" "$chosen"
fi
