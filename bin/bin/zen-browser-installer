#!/usr/bin/env bash

# https://github.com/zen-browser/desktop/releases/latest/download/zen.linux-x86_64.tar.xz

if ! command -v gum >/dev/null 2>&1; then
    echo "gum is a required dependency of this script. See https://github.com/charmbracelet/gum."
    exit 1
fi

INSTALL_DIR="/usr/lib/zen-browser"
URL="https://github.com/zen-browser/desktop/releases/latest/download/zen.linux-x86_64.tar.xz"

gum style \
    --foreground 212 --border-foreground 212 --border double \
    --align center --width 50 --margin "1 2" --padding "2 4" \
    "Welcome to the Zen Browser installer!" "" "Zen Browser will be installed to $INSTALL_DIR"

gum style \
    --foreground 212 --border-foreground 212 --border double \
    --align center --width 50 --margin "1 2" --padding "2 4" \
    "This will download and install Zen Browser from:" "" "$URL"

gum confirm "Proceed with installation?" || exit 0

# Create temporary directory
TMP_DIR=$(mktemp -d -p /var/tmp)
trap "rm -rf $TMP_DIR" EXIT

# Download the tarball
gum spin --spinner dot --title "Downloading Zen Browser..." -- \
    curl -L "$URL" -o "$TMP_DIR/zen.tar.xz"

# Extract to temporary location
gum spin --spinner dot --title "Extracting archive..." -- \
    tar -xf "$TMP_DIR/zen.tar.xz" -C "$TMP_DIR"

# Remove old installation if it exists and install new version
gum spin --spinner dot --title "Installing to $INSTALL_DIR..." -- \
    sudo -A rm -rf "$INSTALL_DIR" && sudo -A mv "$TMP_DIR/zen" "$INSTALL_DIR"

gum style \
    --foreground 212 --border-foreground 212 --border double \
    --align center --width 50 --margin "1 2" --padding "2 4" \
    "Installation complete!" "" "Run 'zen-browser' to launch Zen Browser"
