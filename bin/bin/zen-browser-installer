#!/usr/bin/env bash

if ! command -v gum >/dev/null 2>&1; then
    echo "gum is a required dependency of this script. See https://github.com/charmbracelet/gum."
    exit 1
fi

INSTALL_DIR="$HOME/.local/bin/zen-browser"
REPO="zen-browser/desktop"

# Fetch the latest release URL from GitHub API
URL=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" \
    | grep -oP '"browser_download_url":\s*"\K[^"]*zen-x86_64\.AppImage(?=")')

if [[ -z "$URL" ]]; then
    echo "Failed to fetch latest release URL"
    exit 1
fi

gum style \
    --foreground 212 --border-foreground 212 --border double \
    --align center --width 50 --margin "1 2" --padding "2 4" \
    "Welcome to the Zen Browser installer!" "" "Zen Browser will be installed to $INSTALL_DIR"

gum style \
    --foreground 212 --border-foreground 212 --border double \
    --align center --width 50 --margin "1 2" --padding "2 4" \
    "This will download and install Zen Browser from:" "" "$URL"

gum confirm "Proceed with installation?" || exit 0

# Create temporary directory
TMP_DIR=$(mktemp -d -p /var/tmp)
# A bit dangerous to just remove stuff in scripts...
# trap "rm -rf $TMP_DIR" EXIT

# Download the AppImage
gum spin --spinner dot --title "Downloading Zen Browser..." -- \
    curl -L "$URL" -o "$TMP_DIR/zen-browser"

gum spin --spinner dot --title "Creating executable..." -- \
    chmod +x "$TMP_DIR/zen-browser"

# Remove old installation if it exists and install new version
gum spin --spinner dot --title "Installing to $INSTALL_DIR..." -- \
    sudo -A rm -rf "$INSTALL_DIR"; sudo -A mv "$TMP_DIR/zen-browser" "$INSTALL_DIR"

gum style \
    --foreground 212 --border-foreground 212 --border double \
    --align center --width 50 --margin "1 2" --padding "2 4" \
    "Installation complete!" "" "Run 'zen-browser' to launch Zen Browser"
